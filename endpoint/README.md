# N.E.K.O Plugin Server ç«¯ç‚¹æ–‡æ¡£

> æœ¬ç›®å½•åŒ…å« N.E.K.O Plugin Server æ‰€æœ‰ç«¯ç‚¹çš„è¯¦ç»†æŠ€æœ¯æ–‡æ¡£

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### HTTP REST API ç«¯ç‚¹

1. **[åŸºç¡€è·¯ç”±ç«¯ç‚¹](./01-basic-routes.md)** (3ä¸ªç«¯ç‚¹)
   - å¥åº·æ£€æŸ¥ã€å¯ç”¨æ€§æ£€æŸ¥ã€æœåŠ¡å™¨ä¿¡æ¯
   - æ— éœ€è®¤è¯çš„åŸºç¡€ç«¯ç‚¹

2. **[æ’ä»¶ç®¡ç†ç«¯ç‚¹](./02-plugin-management.md)** (5ä¸ªç«¯ç‚¹)
   - æ’ä»¶åˆ—è¡¨ã€çŠ¶æ€æŸ¥è¯¢
   - æ’ä»¶å¯åŠ¨ã€åœæ­¢ã€é‡è½½
   - éƒ¨åˆ†éœ€è¦ç®¡ç†å‘˜è®¤è¯

3. **[Run Protocol ç«¯ç‚¹](./03-run-protocol.md)** (9ä¸ªç«¯ç‚¹)
   - è¿è¡Œåˆ›å»ºã€çŠ¶æ€æŸ¥è¯¢
   - WebSocket å®æ—¶é€šä¿¡
   - æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€å–æ¶ˆã€å¯¼å‡º
   - æ’ä»¶è°ƒç”¨çš„ä¸»è¦ API

4. **[æ¶ˆæ¯é˜Ÿåˆ—ç«¯ç‚¹](./04-message-queue.md)** (1ä¸ªç«¯ç‚¹)
   - è·å–æ’ä»¶æ¨é€çš„æ¶ˆæ¯
   - æ”¯æŒä¼˜å…ˆçº§è¿‡æ»¤

5. **[æ€§èƒ½ç›‘æ§ç«¯ç‚¹](./05-performance-metrics.md)** (3ä¸ªç«¯ç‚¹)
   - å®æ—¶æ€§èƒ½æŒ‡æ ‡
   - å†å²æ•°æ®æŸ¥è¯¢
   - éœ€è¦ç®¡ç†å‘˜è®¤è¯

6. **[é…ç½®ç®¡ç†ç«¯ç‚¹](./06-config-management.md)** (12ä¸ªç«¯ç‚¹)
   - é…ç½® CRUD æ“ä½œ
   - Profile é…ç½®ç®¡ç†
   - TOML æ ¼å¼è½¬æ¢
   - éœ€è¦ç®¡ç†å‘˜è®¤è¯

7. **[æ—¥å¿—ç®¡ç†ç«¯ç‚¹](./07-log-management.md)** (3ä¸ªç«¯ç‚¹)
   - æ—¥å¿—æŸ¥è¯¢ã€æ–‡ä»¶åˆ—è¡¨
   - WebSocket å®æ—¶æ—¥å¿—æµ
   - éœ€è¦ç®¡ç†å‘˜è®¤è¯

8. **[å‰ç«¯UIç«¯ç‚¹](./08-frontend-ui.md)** (3ä¸ªç«¯ç‚¹)
   - SPA åº”ç”¨å…¥å£
   - é™æ€èµ„æºæœåŠ¡
   - History API fallback

### Message Plane (ZeroMQ)

9. **[Message Plane æœåŠ¡å™¨](./09-message-plane.md)** (9ä¸ªç«¯ç‚¹)
   - RPC Server (7ä¸ªæ“ä½œ)
   - PUB Server (æ¶ˆæ¯å¹¿æ’­)
   - INGEST Server (æ¶ˆæ¯æ‘„å–)
   - åŸºäº ZeroMQ çš„é«˜æ€§èƒ½æ¶ˆæ¯æ€»çº¿

---

## ğŸ“Š ç«¯ç‚¹ç»Ÿè®¡

| ç±»åˆ« | ç«¯ç‚¹æ•°é‡ | è®¤è¯è¦æ±‚ |
|------|---------|---------|
| HTTP REST API | 39 | éƒ¨åˆ†éœ€è¦ |
| Message Plane (ZeroMQ) | 9 | æ—  (ç½‘ç»œéš”ç¦») |
| **æ€»è®¡** | **48** | - |

### è®¤è¯åˆ†ç±»

- **æ— éœ€è®¤è¯**: 18ä¸ª (åŸºç¡€è·¯ç”±ã€éƒ¨åˆ†æ’ä»¶ç®¡ç†ã€Run Protocolã€æ¶ˆæ¯é˜Ÿåˆ—ã€å‰ç«¯UI)
- **éœ€è¦ç®¡ç†å‘˜è®¤è¯**: 21ä¸ª (æœåŠ¡å™¨ä¿¡æ¯ã€æ’ä»¶æ§åˆ¶ã€æ€§èƒ½ç›‘æ§ã€é…ç½®ç®¡ç†ã€æ—¥å¿—ç®¡ç†)

---

## ğŸ”§ æŠ€æœ¯æ ˆ

### HTTP Server
- **æ¡†æ¶**: FastAPI
- **ASGI æœåŠ¡å™¨**: Uvicorn
- **WebSocket**: FastAPI WebSocket
- **å¹¶å‘**: asyncio + ThreadPoolExecutor

### Message Plane
- **æ¶ˆæ¯é˜Ÿåˆ—**: ZeroMQ (ROUTER, PUB, PULL)
- **åºåˆ—åŒ–**: ormsgpack (MessagePack), JSON
- **å­˜å‚¨**: å†…å­˜é˜Ÿåˆ— (deque)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯åŠ¨æœåŠ¡å™¨

```bash
# å¯åŠ¨ HTTP æœåŠ¡å™¨
python -m plugin.user_plugin_server

# å¯åŠ¨ Message Plane
python -m plugin.message_plane.main
```

### é»˜è®¤ç«¯å£

- **HTTP Server**: `http://127.0.0.1:48912`
- **Message Plane RPC**: `tcp://127.0.0.1:48913`
- **Message Plane PUB**: `tcp://127.0.0.1:48914`
- **Message Plane INGEST**: `tcp://127.0.0.1:48915`

### è®¿é—®å‰ç«¯ç®¡ç†ç•Œé¢

```
http://127.0.0.1:48912/ui
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### æ’ä»¶è°ƒç”¨æµç¨‹

1. **åˆ›å»ºè¿è¡Œ**: `POST /runs` â†’ è·å– `run_id` å’Œ `run_token`
2. **WebSocket è¿æ¥**: `WS /ws/run?run_token=xxx`
3. **å®æ—¶é€šä¿¡**: å‘é€è¾“å…¥ã€æ¥æ”¶è¾“å‡º
4. **æŸ¥è¯¢çŠ¶æ€**: `GET /runs/{run_id}`
5. **è·å–ç»“æœ**: `GET /runs/{run_id}/export`

### é…ç½®ç®¡ç†æµç¨‹

1. **è·å–é…ç½®**: `GET /plugin/{id}/config`
2. **ç¼–è¾‘é…ç½®**: ä¿®æ”¹é…ç½®å¯¹è±¡
3. **æ›´æ–°é…ç½®**: `PUT /plugin/{id}/config`
4. **é‡è½½æ’ä»¶**: `POST /plugin/{id}/reload`

### æ—¥å¿—æŸ¥çœ‹æµç¨‹

1. **æŸ¥è¯¢æ—¥å¿—**: `GET /plugin/{id}/logs?lines=100&level=ERROR`
2. **å®æ—¶ç›‘æ§**: `WS /ws/logs/{id}?code=xxx`

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **é…ç½®ä¿®æ”¹éªŒè¯**: ç¦æ­¢ä¿®æ”¹å…³é”®å­—æ®µ (`plugin.id`, `plugin.entry`)
2. **å­—æ®µç±»å‹éªŒè¯**: ä¸¥æ ¼çš„ç±»å‹å’Œæ ¼å¼æ£€æŸ¥
3. **è·¯å¾„éå†é˜²æŠ¤**: é˜²æ­¢è®¿é—®éæ³•è·¯å¾„
4. **Payload å¤§å°é™åˆ¶**: é˜²æ­¢å†…å­˜æº¢å‡º
5. **æ­£åˆ™è¡¨è¾¾å¼è¶…æ—¶**: é˜²æ­¢ ReDoS æ”»å‡»

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **ä¸“ç”¨çº¿ç¨‹æ± **: é¿å…é”ç«äº‰é˜»å¡äº‹ä»¶å¾ªç¯
2. **ç¼“å­˜ç­–ç•¥**: é™æ€èµ„æºé•¿æœŸç¼“å­˜,HTML ç¦ç”¨ç¼“å­˜
3. **æµå¼ä¼ è¾“**: å¤§æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ä½¿ç”¨æµå¼å¤„ç†
4. **è½»é‡çº§å“åº”**: æ”¯æŒ `light` æ¨¡å¼åªè¿”å›ç´¢å¼•
5. **æ‰¹é‡å¤„ç†**: Message Plane æ‰¹é‡æ‘„å–æ¶ˆæ¯
6. **äº‹ä»¶å¾ªç¯ç›‘æ§**: Watchdog æ£€æµ‹é˜»å¡

---

## ğŸ“ æœ€ä½³å®è·µ

1. âœ… **ä½¿ç”¨ Run Protocol**: æ–°ä»£ç åº”ä½¿ç”¨ `/runs` API è€Œéæ—§çš„è§¦å‘å™¨
2. âœ… **Profile ç®¡ç†**: ä½¿ç”¨ Profile ç®¡ç†ä¸åŒç¯å¢ƒçš„é…ç½®
3. âœ… **å®æ—¶ç›‘æ§**: ä½¿ç”¨ WebSocket ç«¯ç‚¹è·å–å®æ—¶æ—¥å¿—å’ŒçŠ¶æ€
4. âœ… **æ¶ˆæ¯æ€»çº¿**: ä½¿ç”¨ Message Plane å®ç°æ’ä»¶é—´é€šä¿¡
5. âœ… **æ€§èƒ½ç›‘æ§**: å®šæœŸæ£€æŸ¥ `/plugin/metrics` ç«¯ç‚¹
6. âœ… **æ—¥å¿—åˆ†æ**: ä½¿ç”¨æ—¥å¿—ç«¯ç‚¹çš„è¿‡æ»¤åŠŸèƒ½å¿«é€Ÿå®šä½é—®é¢˜

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶

- HTTP Server: `plugin/user_plugin_server.py`
- Message Plane Main: `plugin/message_plane/main.py`
- RPC Server: `plugin/message_plane/rpc_server.py`
- PUB Server: `plugin/message_plane/pub_server.py`
- INGEST Server: `plugin/message_plane/ingest_server.py`

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Plugin SDK æ–‡æ¡£](../sdk/)
- [æ’ä»¶å¼€å‘æŒ‡å—](../development/)
- [é…ç½®æ–‡ä»¶æ ¼å¼](../config/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-26  
**ç»´æŠ¤è€…**: N.E.K.O Team
